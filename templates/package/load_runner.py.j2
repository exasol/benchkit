"""Data loading runner for minimal packages (Phase 2)."""

import sys
from pathlib import Path
from typing import Any
import json
from rich.console import Console

console = Console()

def execute_load(config: dict[str, Any], output_dir: Path, force: bool = False) -> None:
    """Execute data loading for configured systems."""
    from .systems.base import get_system_class
    from .workloads.base import get_workload_class
    from .debug import is_debug_enabled

    workload_name = config["workload"]["name"]
    workload_class = get_workload_class(workload_name)

    if not workload_class:
        console.print(f"[red]Error: Unknown workload '{workload_name}'[/]")
        sys.exit(1)

    failed_systems: list[str] = []

    for system_config in config["systems"]:
        system_name = system_config["name"]
        system_kind = system_config["kind"]

        # Check if already loaded
        load_complete_file = output_dir / f"load_complete_{system_name}.json"
        if load_complete_file.exists() and not force:
            console.print(f"[green]✅ {system_name} data already loaded, skipping[/]")
            continue

        console.print(f"[blue]Loading data on {system_name}...[/]")

        # Get system class and create instance
        system_class = get_system_class(system_kind)
        if not system_class:
            console.print(f"[red]Error: Unknown system kind '{system_kind}'[/]")
            failed_systems.append(system_name)
            continue

        system = system_class(system_config)

        # Create workload instance
        workload = workload_class(config["workload"])

        # Prepare workload (generate data, create schema, load data)
        console.print(f"[dim]Preparing workload (data generation & loading)...[/]")
        try:
            if not workload.prepare(system):
                console.print(f"[red]✗ Failed to prepare workload for {system_name}[/]")
                failed_systems.append(system_name)
                continue
            console.print(f"[green]✓ Workload preparation completed[/]")
        except Exception as e:
            console.print(f"[red]✗ Workload preparation failed: {e}[/]")
            if is_debug_enabled():
                import traceback
                console.print(f"[dim]{traceback.format_exc()}[/]")
            failed_systems.append(system_name)
            continue

        # Save load completion marker
        load_complete_data = {
            "system_name": system_name,
            "data_generation_s": 0.0,
            "schema_creation_s": 0.0,
            "data_loading_s": 0.0,
        }

        # Get preparation timings if available
        if hasattr(workload, 'preparation_timings'):
            prep_timings = workload.preparation_timings
            load_complete_data["data_generation_s"] = prep_timings.get("data_generation_s", 0.0)
            load_complete_data["schema_creation_s"] = prep_timings.get("schema_creation_s", 0.0)
            load_complete_data["data_loading_s"] = prep_timings.get("data_loading_s", 0.0)

        from datetime import datetime
        load_complete_data["timestamp"] = datetime.now().isoformat()

        with open(load_complete_file, 'w') as f:
            json.dump(load_complete_data, f, indent=2)

        console.print(f"[green]✓ Load completion marker saved for {system_name}[/]")

    # Exit with error if any systems failed
    if failed_systems:
        console.print(f"[red]Load failed for systems: {', '.join(failed_systems)}[/]")
        sys.exit(1)
